define("gondor/widget/forum",["lib/jquery","mod/lang","mod/scrollbar","gondor/view","gondor/view/dialog","gondor/toolkit","gondor/widget/common","gondor/observer","gondor/sandbox"],function(e,z,a,j,u,c,b,q,o){var x=u.node[0],l=u.body,v="tplTopic",t="tplTopicAdd",p="tplTopicList",s=".wgt-opt",r=".opt-area",i=".post-area",k=".extend-area",n=".comment-form",d=".comment-input",h=".comment-submit",f="#upload-pic",y=".pic-preview",w=".upload-input",m=".submit";var g=function(B){var L=B.pid,K=B.wid,D=B.address,F=B.userInfo,N={userInfo:F,widgetInfo:{pid:L,wid:K,address:D}},M=e("#widget-"+K+" .topic-list"),S=e("ul",M),A=e(".list-wrap",M),R=e(".bn-post",M),O=L?"/api/place/"+L+"/widget/"+K:"/api/widget/"+K,T=O+"/discussion/",C=O+"/forum_add",P=O+"/forum_list";var H=new o({init:function(U,V){b.init();b.resize(U,A,80);b.scrollLoad(A,{action:E});Q();R.bind("click",function(W){W.preventDefault();if(!F.disablePost){b.render({method:"html",data:N,wrapper:l,tplname:t});J()}else{q.fire("citizen:submit-disabled",[F.disablePost])}});M.delegate(".topic-list ul","click",function(Y){Y.preventDefault();var W=Y.target;if(W.className!=="citizen"&&W.className!=="refer-place"&&W.className!=="refer-node"&&!/wgt\-digg/.test(W.className)&&W.nodeName!=="UL"){var Z=e(W).parents("li").data("tid")||e(W).data("tid"),X=e(W).parents("li").data("nav-id")||e(W).data("nav-id");H.navigate({id:Z,navId:X})}})},activate:function(U,V){q.wait("widget:nav",function(W){H.navigate(W)})},destroy:function(U,V){A.remove();R.remove();M.remove()}});H.navigate=function(U){var W=U.id,X=U.navId,V=U.index;u.loading({width:690,isHideTitle:true});if(X){q.fire("app:query from widget",[{cid:X}])}I(W);q.wait("dialog:close",function(){Q();e(x).undelegate("click");l.html("");q.fire("app:query from widget",[{cid:false}])})};function I(U){b.render({url:T+U+"/view",data:N,wrapper:l,method:"html",tplname:v},"loaded");b.evt.wait("loaded",function(W){u.update();var Y=e(s,x).data("tid"),aa=e(d,x),V=e(".cmt",x),Z=parseInt(V.text(),10),X=e(h,x);b.switchBnDisabled(X,0);b.commentEvt({base:e(x),wrap:l,url:T,id:Y,commentDetail:W,callBack:function(){V[0].innerHTML=Z+1;Z+=1},tmplExtra:N});e(x).delegate(s,"click",function(ac){ac.preventDefault();var ab=ac.target;if(ab.className==="cmt"){e(d,x).focus()}});e(".wgt-opt2",x).bind("click",function(ab){ab.preventDefault();if(ab.target.className==="del"){u.confirm("确定删除此发言？",function(){c.post(T+U+"/delete",function(ac){if(!ac.r){u.close()}})})}})})}function E(){var U=S.children().length;b.render({url:P,data:N,args:{start:U,limit:30},wrapper:S,method:"append",tplname:p},"topicLoaded");b.evt.wait("topicLoaded",function(){a.init(A[0],{hasShadow:true})})}function Q(){b.render({url:P,data:N,args:{limit:30},wrapper:S,method:"html",tplname:p},"reloaded");b.evt.wait("reloaded",function(){a.init(A[0],{hasShadow:true})})}function J(){var U=e(i,x),Y=e(f,x),W=e(k,x),V=e(".upload-tips",x),X='<img id="{FID}" class="pic-preview" src="{SRC}" />';e(r,x).bind("click",function(aa){aa.preventDefault();var Z=aa.target;if(Z.tagName==="A"){e(k,x).show();e(i,x).addClass("combo");e("."+Z.name,x).show();if(Z.name==="pic-area"){require(["lib/jquery.upload"],function(){Y.iframePostForm({post:function(){G(0);V.show();e(w,x).hide()},complete:function(ae){V.hide();var ad=e.parseJSON(e.browser.msie?ae:e(ae).text());var ac=e(w,x),ab=ac.clone(true);Y.append(X.replace("{FID}",ad.pic.id).replace("{SRC}",ad.pic.thumb_src));ac.remove();ab.prependTo(f);G(1)}}).find(w).change(function(){e(this).parent().submit()})})}}});e(".file-close",x).bind("click",function(){W.hide();U.removeClass("combo");e(w,x).show();e(y,x).remove()});e(i,x).bind("keyup",function(Z){G(Z.target.value)});e(m,x).bind("click",function(Z){Z.preventDefault();G(0);c.post(C,{text:e(i,x).val(),pic:e(y,x).attr("id")},function(aa){if(!aa.r&&!aa.need_captcha){u.close();S.animate({scrollTop:0},500);b.render({data:z.mix(N,{items:[aa.discussion]}),wrapper:S,method:"prepend",tplname:p},"oneLoaded");b.evt.wait("oneLoaded",function(){a.init(A[0],{hasShadow:true})});if(aa.task_info){j.alert(aa.task_info.comment,undefined,{title:aa.task_info.name})}}else{if(aa.need_capcha){u.confirm("你发言的频率太高了，休息一下吧。")}else{u.confirm("留言失败，请稍后再试")}}},"json")});q.wait("dialog:close",function(){e(".close",x).unbind("click");e(r,x).unbind("click");e(i,x).unbind("keyup");e(m,x).unbind("click");l.html("")});u.set({width:470,isHideTitle:true}).open();U.focus()}function G(U){e(m,x)[U?"addClass":"removeClass"]("active").prop("disabled",U?"":"disabled")}return H};return g});