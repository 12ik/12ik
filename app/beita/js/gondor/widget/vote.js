define("gondor/widget/vote",["lib/jquery","mod/lang","mod/cookie","mod/template","gondor/toolkit","mod/scrollbar","gondor/view","gondor/view/dialog","gondor/widget/common","gondor/widget/ui/list","gondor/observer","gondor/sandbox"],function(e,w,v,f,d,a,k,t,h,o,r,q){var u=t.node[0],m=t.body,g="tplVote",i="tplVoteAdd",j="tplVoteEdit",p="tplVoteItem",n="tplEntryList",s=".wgt-opt",c="vote-item-hover",b="vote-item-active";var l=function(x){var J=x.pid,I=x.wid,E=x.userInfo,C=x.address,L={userInfo:E,widgetInfo:{pid:J,wid:I,address:C}},K=e("#widget-"+I+" .wrap"),N=e(".bn-post",K),D=e(".entry-list",K),F=e(".section",K),y="/api/place/"+J+"/widget/"+I,G=y+"/vote/",z=y+"/latest",P=y+"/add",Q=y+"/list",M=o({self:K,section:F,entryList:D,URL_BASE:G,URL_LATEST:z,URL_LIST:Q,TN_CONTENT:g,TN_LIST:n,contentCb:function(T){var S=e(".vote-line",K),R=S.width(),U=e(s,K).data("vid");e.each(e("em",S),function(W,V){e(V).animate({width:e(V).attr("class").split("-")[1]*R*0.01||5},500)});e(".section",K).animate({scrollTop:0},200);O(U,T)},tmplExtra:L});var H=new q({init:function(R,S){h.init();h.resize(R,e(".aside",K));h.resize(R,e(".section",K),40);M.renderContent();M.renderList();N.bind("click",function(ab){ab.preventDefault();h.render({data:w.mix({existItems:[1,2,3,4,5,6,7,8,9,10],optHour:["07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23","00","01","02","03","04","05","06"],optMinute:["00","05","15","20","25","30","35","40","45","50","55"],expireDate:h.nextDate(60*60*24*30)},L),wrapper:m,method:"html",tplname:i});t.set({width:580,isHideTitle:true}).open();var Y=e(".vote-items",u),ac=e(".vote-title",u),Z=e(".item-desc",u),U=e(".vote-cancel",u),W=e(".ln-add-desc",u),X=e(".ln-add-vote",u),ad=e(".select-type",u),V=e(".vote-err",u),T=function(){var af=e("#expire-day").val().split("-"),ae=e("#expire-hour").val()||0,ag=e("#expire-minute").val()||0;return new Date(af[0],af[1]-1,af[2],ae,ag)},aa=function(){V.hide();var af={},ae=Y.serialize();e.each(ae.split("&"),function(ah,ag){ag=ag.split("=");af[ag[0]]=ag[1]});d.post(P,{title:af["vote-title"],description:af["vote-desc"],max_choice:af.maxchoices,expire_time:af["expire-day"]+" "+af["expire-hour"]+":"+af["expire-minute"],choice:ae,share_to:Array.prototype.map.call(Y.find(".sns-sync-btn"),function(ag){return ag.checked?ag.value:""})},function(ag){if(!ag.r){t.close();M.renderContent();M.renderList()}},"json")};W.bind("click",function(ae){ae.preventDefault();Z.toggle()});X.bind("click",B);U.bind("click",function(ae){ae.preventDefault();t.close()});ad.bind("change",function(){e("#max-item",u).toggle(e(this).children(":selected").val()==="M")});e(".sns-sync-field",Y).delegate(".sns-sync-btn","click",function(af){var ae=e(af.target).val();if(!E[ae]&&!v(ae+"_cookie_bound")){var ag={ap_douban:{text:"绑定豆瓣帐号",link:"/accounts/oauth_login_request?source=ap_douban"},ap_weibo:{text:"绑定微博帐号",link:"/accounts/oauth_login_request?source=ap_weibo"}};t.confirm(f.format('请先绑定帐号：<a href="{{link}}" target="_blank">{{text}}</a>',ag[ae]));af.preventDefault()}});Y.bind("submit",function(ae){ae.preventDefault();A({items:[{con:!e.trim(ac.val()),error:"请填写投票主题"},{con:e('.vote-item[value!=""]',u).length<2,error:"至少需要两个选项"},{con:ad.find(":selected").val()==="M"&&!e.trim(e("#max-choices").val()),error:"当投票为多选时，投票选项“最多”处应填写大于1的数字"},{con:(new Date()>T()),error:"结束时间不能早于当前时间"}],errDiv:V,success:aa})});r.wait("dialog:close",function(){W.unbind("click");X.unbind("click");U.unbind("click");ad.unbind("change");Y.unbind("submit");m.html("")})})},activate:function(R,S){r.wait("widget:nav",function(T){H.navigate(T)})},destroy:function(R,S){N.remove()}});H.navigate=function(R){M.navigate(R)};function B(R){R.preventDefault();h.render({data:{num:e(".item",u).length-3},wrapper:e(".item-add:last",u),method:"before",tplname:p})}function O(S,R){a.init(F[0],{hasShadow:true});F.animate({scrollTop:0},200);e(".item-mark",K).bind("mouseenter",function(T){e(this).addClass(c)}).bind("mouseleave",function(T){e(this).removeClass(c)}).bind("click",function(U){var T=e("input",this),V=T.attr("checked");if(T.attr("type")==="radio"){e(".item-mark",K).removeClass(b)}if(T.length){if(U.target.nodeName==="INPUT"||U.target.nodeName==="LABEL"){V=!V}T.prop("checked",V?"":"checked");e(this)[!V?"addClass":"removeClass"](b)}});e(".voting-form",K).bind("submit",function(V){V.preventDefault();var U=[],W=parseInt(e(".maxchoice",K).text(),10),T=e(":checked",this);if(T.length>W){t.set({width:250,isHideTitle:true,content:"最多可选"+W+"项",buttons:[{text:"知道了",method:function(){t.close()}}]}).open()}else{e.each(T,function(Y,X){U[Y]=parseInt(e(X).attr("id").split("-")[1],10)});d.post(G+S+"/vote?needauth=1",{choices:U},function(X){if(!X.r){M.renderContent(S)}else{if(X.r==20){r.fire("citizen:submit-disabled",[X.reason])}}},"json");U.length=0}});e(s,F).bind("click",function(V){V.preventDefault();var T=V.target,U;switch(T.className){case"del":k.alert("确定删除此投票？",function(){d.post(G+S+"/delete",function(W){if(!W.r){M.renderContent();M.renderList()}},"json")});break;case"top":U=e(T);U.text("置顶中...").attr("class","topping");d.post(G+S+"/top",function(W){if(W.r){return}U.text("取消置顶").attr("class","untop");M.renderList()},"json");break;case"untop":U=e(T);U.text("取消置顶中...").attr("class","untopping");d.post(G+S+"/untop",function(W){if(W.r){return}U.text("置顶").attr("class","top");M.renderList()},"json");break;case"edit":h.render({url:G+S+"/view",wrapper:m,method:"html",tplname:j},"loaded");h.evt.wait("loaded",function(Y){var ab=e(".ln-add-vote",u),X=e(".vote-edit-form",u),aa=(e(".expire-time",K).text()).split(" "),Z=aa[0],W=aa[1].split(":");e("#expire-day").val("2011-"+Z);e('#expire-hour [value="'+~~W[0]+'"]',u).attr("selected","selected");e('#expire-minute [value="'+~~W[1]+'"]',u).attr("selected","selected");ab.bind("click",B);X.bind("submit",function(af){af.preventDefault();var ad={},ag=e(this).attr("id").split("-")["1"],ae=e('.vote-desc:not(":disabled")',u).val(),ac=e(this).serialize();e.each(ac.split("&"),function(ai,ah){ah=ah.split("=");ad[ah[0]]=ah[1]});d.post(G+ag+"/update",{desc:ae,choice:ac,expire_time:ad["expire-day"]+" "+ad["expire-hour"]+":"+ad["expire-minute"]},function(ah){if(!ah.r){t.close();M.renderContent(ag)}},"json")});r.wait("dialog:close",function(){ab.unbind("click");X.unbind("submit");m.html("")})});t.set({width:580,isHideTitle:true}).open();break;default:break}});h.commentEvt({base:K,wrap:F,url:G,id:S,commentDetail:R,tmplExtra:L})}function A(R){var S=false;e.each(R.items.reverse(),function(U,T){if(T.con){S=true;R.errDiv.text(T.error).show()}});h.switchBnDisabled(e("#submit",u),S);if(!S){R.success()}}return H};return l});