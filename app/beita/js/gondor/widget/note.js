define("gondor/widget/note",["lib/jquery","mod/template","mod/cookie","gondor/toolkit","mod/scrollbar","gondor/view","gondor/view/dialog","gondor/widget/common","gondor/widget/ui/list","gondor/observer","gondor/sandbox"],function(h,i,x,g,a,m,u,f,p,s,r){var w=u.node[0],o=u.body,d="tplNote",j="tplEntryList",k="tplNotePreview",c="tplPicItem",b="tplNoteEdit",z="[{TITLE}]({URL})",n="[](media:{URL})",t=".wgt-opt",e=".note-text",q=".note-title",v=".upload-input",y=".upload-pic-form";var l=function(B){var K=B.pid,J=B.wid,F=B.userInfo,D=B.address,M={userInfo:F,widgetInfo:{pid:K,wid:J,address:D}},L=h("#widget-"+J+" .wrap"),Q=h(".bn-post",L),E=h(".entry-list",L),G=h(".section",L),R="/api/place/"+K+"/widget/"+J,A=R+"/note/",N=R+"/list",P=R+"/latest",O=p({self:L,section:G,entryList:E,wid:J,URL_BASE:A,URL_LATEST:P,URL_LIST:N,TN_CONTENT:d,TN_LIST:j,contentCb:function(S){var T=h(t,L).data("vid");C(T,S)},tmplExtra:M});var H=new r({init:function(S,T){f.init();f.resize(S,h(".aside",L));f.resize(S,h(".section",L),40);O.renderContent();O.renderList();Q.bind("click",function(U){U.preventDefault();u.setContent(i.convertTpl(b,M));I()})},activate:function(S,T){s.wait("widget:nav",function(U){H.navigate(U)})},destroy:function(S,T){Q.remove()}});H.navigate=function(S){O.navigate(S)};function C(T,S){a.init(G[0],{hasShadow:true});G.animate({scrollTop:0},200);f.commentEvt({base:L,wrap:G,url:A,id:T,commentDetail:S,tmplExtra:M});h(".edit",L).bind("click",function(U){U.preventDefault();f.render({url:A+T+"/view",data:M,wrapper:o,method:"html",tplname:b},"editLoaded");u.set({width:680,isHideTitle:true}).open();f.evt.wait("editLoaded",function(){I(T)})});h(t,L).bind("click",function(V){V.preventDefault();var W=h(this).data("vid"),U;if(V.target.className==="del"){m.alert("确认要删除？",function(){g.post(A+W+"/delete",function(X){if(!X.r){O.renderContent();O.renderList()}})})}else{if(V.target.className==="top"){U=h(V.target);U.text("置顶中...").attr("class","topping");g.post(A+W+"/top",function(X){if(X.r){return}U.text("取消置顶").attr("class","untop");O.renderList()},"json")}else{if(V.target.className==="untop"){U=h(V.target);U.text("取消置顶中...").attr("class","untopping");g.post(A+W+"/untop",function(X){if(X.r){return}U.text("置顶").attr("class","top");O.renderList()},"json")}}}});h(".col2-bd > p",L).bind("click",function(U){U.preventDefault();if(U.target.tagName==="A"){window.open(U.target.href)}})}function I(T){var aa=T||0,S=h(".note-bd",w),X=h(".note-form",w),W=h(".editor-box",w),Z=h(".editor-items a",w),V=h(".bn-flat-hot",w),ab=h(".bn-submit",w),U=h(".upload-tips",w),Y=h(y,w);s.wait("dialog:close",function(){W.unbind("close");Z.unbind("click");h(".cancel",w).unbind("click");h(".add-link-form",w).unbind("submit");h(".add-video-form",w).unbind("submit");Y.unbind("submit");h(w).undelegate(".pic-preview","click");h(w).undelegate(".pic-desc","keyup focusout");o.html("")});u.set({width:680,isHideTitle:true}).open();V.last().hide();W.bind("close",function(){h(this).hide();Z.removeClass("on");h(".item input",this).val("")});Z.bind("click",function(ad){ad.preventDefault();var ac=h(this),ae=ac.hasClass("on");Z.removeClass("on");ac[ae?"remove":"addClass"]("on");W[ae?"hide":"show"]().css({right:(Z.length-ac.index()-1)*(20+ac.width()+5)+"px"}).children().hide();h("."+ac.data("form"))[ae?"hide":"show"]()});h(".cancel",w).bind("click",function(ac){ac.preventDefault();u.close()});h(".add-link-form",w).bind("submit",function(af){af.preventDefault();var ae=h(this),ag=ae.find(".ln-url").val(),ad=ae.find(".ln-title").val(),ac=z.replace(/\{TITLE\}/g,ad).replace("{URL}",ag);if(ag){f.cursorMethod.insertAfterCursor(h(".note-text")[0],ac);W.trigger("close")}}).find(".link-cancel").bind("click",function(){W.trigger("close")});h(".add-video-form",w).bind("submit",function(ah){ah.preventDefault();var ac="/api/video/check",ag=false,ad=h(this),ae=ad.find(".video-url").val(),af=n.replace("{URL}",ae.replace("http://",""));g.getJSON(ac,{url:ae},function(ai){if(ai.r){u.confirm("无效的视频地址");return}f.cursorMethod.insertAfterCursor(h(".note-text")[0],af);W.trigger("close");return},"json")}).find(".video-cancel").bind("click",function(){W.trigger("close")});require(["lib/jquery.upload"],function(){var ac=h(".pic-preview",w);Y.iframePostForm({post:function(){U.show();f.switchBnDisabled(ab,0);h(v,w).hide()},complete:function(ah){U.hide();var ad=ac.children().length+1,ag=h.parseJSON(h.browser.msie?ah:h(ah).text()),af=h(v,w),ae=af.clone(true);if(ag.r!==0){u.confirm(ag.msg||"出错啦")}else{f.render({data:{idx:ad,pid:ag.photo.id,url:ag.photo.small_src},wrapper:ac,method:"append",tplname:c});f.cursorMethod.insertAfterCursor(h(".note-text",w)[0],"<图片"+ad+">")}af.remove();ae.prependTo(y).show();f.switchBnDisabled(ab,1);W.trigger("close")}}).find(v).bind("change",function(){h(this).parent().submit()})});h(w).delegate(".pic-preview","click",function(ad){var ac=ad.target;switch(ac.className){case"desc-tips":h(ac).next().show().focus().end().hide();break;case"bn-del":ad.preventDefault();u.confirm("确定要删除该图片？",function(){var ah=h(ac).parent(),ak=h(".note-text",w),ae="<"+h(ac).next().text()+">",ag=parseInt((/\d+/.exec(ae)||[])[0],10),af=ah.siblings().andSelf(),aj=af.length;ac.className="bn-deleting";ak[0].value=ak[0].value.replace(new RegExp(ae,"g"),"");for(var ai=ag+1;ai<=aj;ai++){ak[0].value=ak[0].value.replace(new RegExp("<图片"+ai+">","g"),"<图片"+(ai-1)+">");af.eq(ai-1).find(".name").text("图片"+(ai-1))}ah.fadeOut(function(){ah.remove()})});break;default:break}});h(w).delegate(".pic-desc","keyup focusout",function(ac){if(ac.type==="focusout"||ac.keyCode===13){var ad=h(this).val()||"点击添加描述";h(this).prev().show().text(ad).end().hide()}});h(".bn-preview",w).bind("click",function(ac){S.children(':not(".item-submit")').hide();V.hide().last().show();var ad={};ad.note_id=h(t,L).data("vid");ad.title=X.find(q).val();ad.text=X.find(e).val();h.each(h(".pic-preview",w).children(".item"),function(ag,ae){var af="img"+(ag+1);ae=h(ae);ad[af+"_id"]=ae.attr("id").split("-")[1];ad[af+"_desc"]=ae.find(".pic-desc").val();ad[af+"_pos"]=ae.find(":radio:checked").attr("id").split("-")[0]});f.render({url:R+"/preview",args:ad,wrapper:S,method:"prepend",tplname:k})});h(".bn-back",w).bind("click",function(ac){h(".note-preview",w).remove();S.children().show();V.show().last().hide()});X.find(".bn-submit, .bn-update").bind("click",function(ag){var ai=h(t,L).data("vid"),ad=ag.target.className==="bn-update",ae=!ad?R+"/add":A+ai+"/update";ag.preventDefault();var ac=[],af="",ah={};ah.title=X.find(q).val();ah.text=X.find(e).val();ah.noreply=X.find("#noreply").is(":checked");ah.share_to=Array.prototype.map.call(X.find(".sns-sync-btn"),function(aj){return aj.checked?aj.value:""});h.each(h(".pic-preview",w).children(".item"),function(ak,aj){aj=h(aj);af="img"+(ak+1);ah[af+"_id"]=aj.attr("id").split("-")[1];ah[af+"_desc"]=aj.find(".pic-desc").val();ah[af+"_pos"]=aj.find(":radio:checked").attr("id").split("-")[0]});if(ah.title&&ah.text){g.post(ae,ah,function(aj){u.close();if(ad){O.renderContent(ai)}else{O.renderContent();O.renderList()}},"json")}});h(t,w).delegate(".sns-sync-btn","click",function(ad){var ac=h(ad.target).val();if(!F[ac]&&!x(ac+"_cookie_bound")){var ae={ap_douban:{text:"绑定豆瓣帐号",link:"/accounts/oauth_login_request?source=ap_douban"},ap_weibo:{text:"绑定微博帐号",link:"/accounts/oauth_login_request?source=ap_weibo"}};u.confirm(i.format('请先绑定帐号：<a href="{{link}}" target="_blank">{{text}}</a>',ae[ac]));ad.preventDefault()}})}return H};return l});