define("gondor/widget/poll",["lib/jquery","mod/lang","mod/cookie","mod/template","gondor/toolkit","mod/scrollbar","gondor/view","gondor/view/dialog","gondor/widget/common","gondor/widget/ui/list","gondor/observer","gondor/sandbox"],function(h,w,u,i,g,a,j,s,l,n,p,o){var t=s.node[0],m=s.body,k="tplPoll",v="tplPollEdit",e="tplPollItem",c="tplEntryList",f="tplPollAdd",q=".wgt-opt",d="vote-item-hover",b="vote-item-active";var r=function(x){var I=x.pid,F=x.wid,B=x.userInfo,z=x.address,K={userInfo:B,widgetInfo:{pid:I,wid:F,address:z}},J=h("#widget-"+F+" .wrap"),O=h(".bn-post",J),A=h(".entry-list",J),C=h(".section",J),D="/api/place/"+I+"/widget/"+F,P=D+"/poll/",N=D+"/latest",L=D+"/add",H=D+"/list",M=n({self:J,section:C,entryList:A,URL_BASE:P,URL_LATEST:N,URL_LIST:H,TN_CONTENT:k,TN_LIST:c,contentCb:function(R){var S=h(".vote-line",J),Q=S.width(),T=h(q,J).data("vid");h.each(h("em",S),function(V,U){h(U).animate({width:h(U).attr("class").split("-")[1]*Q*0.01||5},500)});h(".section",J).animate({scrollTop:0},200);G(T,R)},tmplExtra:K});var E=new o({init:function(R,Q){l.init();l.resize(R,h(".aside",J));l.resize(R,h(".section",J),40);M.renderContent();M.renderList();O.bind("click",function(Y){Y.preventDefault();l.render({data:w.mix({optHour:["07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23","00","01","02","03","04","05","06"],optMinute:["00","05","15","20","25","30","35","40","45","50","55"],expireDate:l.nextDate(60*60*24*30)},K),wrapper:m,method:"html",tplname:f});s.set({width:580,isHideTitle:true}).open();var V=h(".vote-items",t),aa=h(".vote-title",t),W=h(".item-desc",t),T=h(".vote-cancel",t),U=h(".ln-add-desc",t),ab=h(".select-type",t),X=h(".vote-err",t),S=function(){var ad=h("#expire-day").val().split("-"),ac=h("#expire-hour").val()||0,ae=h("#expire-minute").val()||0;return new Date(ad[0],ad[1]-1,ad[2],ac,ae)},Z=function(){X.hide();var ad={},ac=V.serialize();h.each(ac.split("&"),function(af,ae){ae=ae.split("=");ad[ae[0]]=ae[1]});g.post(L,{title:ad["vote-title"],description:ad["vote-desc"],max_choice:ad.maxchoices,expire_time:ad["expire-day"]+" "+ad["expire-hour"]+":"+ad["expire-minute"],choice:ac,share_to:Array.prototype.map.call(V.find(".sns-sync-btn"),function(ae){return ae.checked?ae.value:""})},function(ae){if(!ae.r){s.close();M.renderContent();M.renderList()}},"json")};U.bind("click",function(ac){ac.preventDefault();W.toggle()});T.bind("click",function(ac){ac.preventDefault();s.close()});h(".sns-sync-field",V).delegate(".sns-sync-btn","click",function(ad){var ac=h(ad.target).val();if(!B[ac]&&!u(ac+"_cookie_bound")){var ae={ap_douban:{text:"绑定豆瓣帐号",link:"/accounts/oauth_login_request?source=ap_douban"},ap_weibo:{text:"绑定微博帐号",link:"/accounts/oauth_login_request?source=ap_weibo"}};s.confirm(i.format('请先绑定帐号：<a href="{{link}}" target="_blank">{{text}}</a>',ae[ac]));ad.preventDefault()}});V.bind("submit",function(ac){ac.preventDefault();y({items:[{con:!aa.val().trim(),error:"请填写投票主题"},{con:(new Date()>S()),error:"结束时间不能早于当前时间"}],errDiv:X,success:Z})});p.wait("dialog:close",function(){U.unbind("click");T.unbind("click");V.unbind("submit");m.html("")})})},activate:function(Q,R){p.wait("widget:nav",function(S){E.navigate(S)})},destroy:function(Q,R){O.remove()}});E.navigate=function(Q){M.navigate(Q)};function G(S,R){var Q=h("#user-poll",J);a.init(C[0],{hasShadow:true});C.animate({scrollTop:0},200);h(".item-mark",J).bind("mouseenter",function(T){h(this).addClass(d)}).bind("mouseleave",function(T){h(this).removeClass(d)}).bind("click",function(U){var T=h("input",this),V=T.prop("checked");if(T.attr("type")==="radio"){h(".item-mark",J).removeClass(b)}if(T.length){if(U.target.tagName==="INPUT"||U.target.tagName==="LABEL"){V=!V}T.prop("checked",V?"":"checked");h(this)[!V?"addClass":"removeClass"](b);Q.focus()}});h(".voting-form",J).bind("submit",function(W){W.preventDefault();var T=h(":checked",this).attr("id"),U=T.search("user")===-1?parseInt(T.split("-")[1],10):"",V=h("#user-poll",this).val();g.post(P+S+"/vote?needauth=1",{"item-0":U,"item-1":V},function(X){if(!X.r){M.renderContent(S)}else{if(X.r==20){p.fire("citizen:submit-disabled",[X.reason])}}},"json")});h(q,C).bind("click",function(V){V.preventDefault();var T=V.target,U;switch(T.className){case"del":j.alert("确定删除此投票？",function(){g.post(P+S+"/delete",function(W){if(!W.r){M.renderContent();M.renderList()}},"json")});break;case"top":U=h(T);U.text("置顶中...").attr("class","topping");g.post(P+S+"/top",function(W){if(W.r){return}U.text("取消置顶").attr("class","untop");M.renderList()},"json");break;case"untop":U=h(T);U.text("取消置顶中...").attr("class","untopping");g.post(P+S+"/untop",function(W){if(W.r){return}U.text("置顶").attr("class","top");M.renderList()},"json");break;case"edit":l.render({url:P+S+"/view",data:K,wrapper:m,method:"html",tplname:v},"loaded");l.evt.wait("loaded",function(Z){var X=h(".ln-add-vote",t),W=h(".vote-edit-form",t),ab=(h(".expire-time",J).text()).split(" "),aa=ab[0],Y=ab[1].split(":");h("#expire-day").val("2011-"+aa);h('#expire-hour [value="'+~~Y[0]+'"]',t).attr("selected","selected");h('#expire-minute [value="'+~~Y[1]+'"]',t).attr("selected","selected");W.bind("submit",function(ag){ag.preventDefault();var ad={},ah=h(this).attr("id").split("-")["1"],ae=h(this).serialize(),af=h('.vote-desc:not(":disabled")',t).val(),ac=h(this).serialize();h.each(ac.split("&"),function(aj,ai){ai=ai.split("=");ad[ai[0]]=ai[1]});g.post(P+ah+"/update",{desc:af,choices:ae,expire_time:ad["expire-day"]+" "+ad["expire-hour"]+":"+ad["expire-minute"]},function(ai){if(!ai.r){s.close();M.renderContent(ah)}},"json")});p.wait("dialog:close",function(){X.unbind("click");W.unbind("submit");m.html("")})});s.set({width:580,isHideTitle:true}).open();break;default:break}});l.commentEvt({base:J,wrap:C,url:P,id:S,commentDetail:R,tmplExtra:K})}function y(Q){var R=false;h.each(Q.items.reverse(),function(T,S){if(S.con){R=true;Q.errDiv.text(S.error).show()}});l.switchBnDisabled(h("#submit",t),R);if(!R){Q.success()}}return E};return r});