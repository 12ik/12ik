define("gondor/widget/album",["lib/jquery","mod/lang","mod/key","gondor/toolkit","mod/editable","mod/scrollbar","gondor/view/dialog","gondor/widget/common","gondor/observer","gondor/sandbox"],function(e,r,f,c,l,a,o,j,m,k){var p=o.node[0],i=o.body,d="tplPhoto",b="tplPhotoList",h="tplComment",n=".wgt-opt",g=".comment-submit";var q=function(v){var F=v.pid,C=v.wid,z=v.userInfo,x=v.address,H={userInfo:z,widgetInfo:{pid:F,wid:C,address:x}},G=e("#widget-"+C+" .photo-list"),D=e("ul",G),t=e(".list-wrap",G),J=e(".bn-post",G),B="/api/place/"+F+"/widget/"+C+"/photo/",s="/api/place/"+F+"/widget/"+C+"/photos",w="/api/place/"+F+"/widget/"+C+"/photo_upload",I=false,u;var A=new k({init:function(M,N){j.init();j.resize(M,t,80);u=y();j.scrollLoad(t,{action:E});L();J.click(function(O){O.preventDefault();o.set({width:630,isHideTitle:true,iframeURL:w}).open();m.wait("dialog:close",function(){L();i.html("")})});G.delegate(".photo-list ul","click",function(Q){Q.preventDefault();var O=Q.target,R=O.id.split("-")[1],P=e(O).data("nav-id");if(O.className==="photo"){A.navigate({id:R,navId:P})}})},activate:function(M,N){m.wait("widget:nav",function(O){A.navigate(O)})},destroy:function(M,N){J.remove();G.undelegate(".photo-list ul","click")}});A.navigate=function(N){var P=N.id,R=N.navId,O=N.index;o.loading({width:690,isHideTitle:true});var M=f();M.down("left",function(T){T.preventDefault();var S=i.find(".photo-view img");K(S.data("prev"),S.data("prev-nav"))});M.down("right",function(T){T.preventDefault();var S=i.find(".photo-view img");K(S.data("next"),S.data("next-nav"))});e(p).delegate(".photo-view img","click",function(T){var S=i.find(".photo-view img");K(S.data("next"),S.data("next-nav"))});function Q(){i.html("");i.siblings(".photo-next-btn, .photo-prev-btn").remove();M.reset();I=false;e(p).undelegate(".photo-view img","click");m.cancel("dialog:close",Q);m.cancel("dialog:setcontent",Q);m.fire("app:query from widget",[{cid:false}])}m.wait("dialog:close",Q);m.wait("dialog:setcontent",Q);K(P,R)};function E(){var M=D.children().length;j.render({url:s,args:{start:M,limit:u},wrapper:D,method:"append",tplname:b},"photoLoaded");j.evt.wait("photoLoaded",function(){a.init(t[0],{hasShadow:true})})}function L(){j.render({url:s,args:{limit:u},wrapper:D,method:"html",tplname:b},"reloaded");j.evt.wait("reloaded",function(){a.init(t[0],{hasShadow:true})})}function K(N,M){j.render({url:B+N+"/view",data:H,wrapper:i,method:"html",tplname:d},"loaded");if(M){m.fire("app:query from widget",[{cid:M}])}j.evt.wait("loaded",function(P){o.update();if(!I){I=true;var R=e('<div class="photo-prev-btn"></div>');var O=e('<div class="photo-next-btn"></div>');i.after(R);i.after(O);R.click(function(){var S=i.find(".photo-view img");K(S.data("prev"),S.data("prev-nav"))});O.click(function(){var S=i.find(".photo-view img");K(S.data("next"),S.data("next-nav"))})}i.siblings(".photo-next-btn, .photo-prev-btn").css({top:o.node.outerHeight()/2-23-50+"px"});var Q=e(g,p);j.switchBnDisabled(Q,0);e(n,i).bind("click",function(T){T.preventDefault();var S;if(T.target.className==="del"){o.confirm("确定要删除此照片？",function(){c.post(B+N+"/delete",function(U){if(!U.r){L();o.close()}else{o.confirm("照片删除失败，请稍后再试")}},"json")})}else{if(T.target.className==="top"){S=e(T.target);S.text("置顶中...").attr("class","topping");c.post(B+N+"/top",function(U){if(U.r){return}S.text("取消置顶").attr("class","untop")},"json")}else{if(T.target.className==="untop"){S=e(T.target);S.text("取消置顶中...").attr("class","untopping");c.post(B+N+"/untop",function(U){if(U.r){return}S.text("置顶").attr("class","top")},"json")}}}});j.commentEvt({base:e(p),wrap:i,url:B,id:N,commentDetail:P,tmplExtra:H})})}function y(){var Q=t.width(),M=t.height(),R=135,P=135;var N=Math.floor(Q/R)||1,O=Math.ceil(M/P)+1;return N*O}return A};return q});