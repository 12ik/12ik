define("gondor/widget/election",["lib/jquery","mod/lang","mod/cookie","mod/template","gondor/toolkit","mod/scrollbar","gondor/view","gondor/view/dialog","gondor/widget/common","gondor/widget/ui/list","gondor/observer","gondor/sandbox"],function(g,v,u,h,e,a,j,r,f,m,p,o){var t=r.node[0],l=r.body,s="tplElection",b="tplElectionEdit",i="tplEntryList",k="tplElectionAdd",q=".wgt-opt",d="vote-item-hover",c="vote-item-active";var n=function(w){var I=w.pid,H=w.wid,C=w.userInfo,z=w.address,K={userInfo:C,widgetInfo:{pid:I,wid:H,address:z}},J=g("#widget-"+H+" .wrap"),O=g(".bn-post",J),B=g(".entry-list",J),F=g(".section",J),D="/api/place/"+I+"/widget/"+H,L=D+"/election/",N=D+"/latest",E=D+"/add",A=D+"/list",M=m({self:J,section:F,entryList:B,URL_BASE:L,URL_LATEST:N,URL_LIST:A,TN_CONTENT:s,TN_LIST:i,contentCb:function(Q){var S=g(".vote-line",J),P=S.width(),R=g(q,J).data("vid");g.each(g("em",S),function(U,T){g(T).animate({width:g(T).attr("class").split("-")[1]*P*0.01||5},500)});g(".section",J).animate({scrollTop:0},200);y(R,Q)},tmplExtra:K});var G=new o({init:function(P,Q){f.init();f.resize(P,g(".aside",J));f.resize(P,g(".section",J),40);M.renderContent();M.renderList();O.bind("click",function(Y){Y.preventDefault();f.render({data:v.mix({optHour:["07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23","00","01","02","03","04","05","06"],optMinute:["00","05","15","20","25","30","35","40","45","50","55"],expireDate:f.nextDate(60*60*24*30)},K),wrapper:l,method:"html",tplname:k});r.set({width:580,isHideTitle:true}).open();var V=g(".vote-items",t),Z=g(".vote-title",t),W=g(".item-desc",t),T=g(".vote-cancel",t),U=g(".ln-add-desc",t),aa=g(".select-type",t),X=g(".vote-err",t),S=function(){var ac=g("#expire-day").val().split("-"),ab=g("#expire-hour").val()||0,ad=g("#expire-minute").val()||0;return new Date(ac[0],ac[1]-1,ac[2],ab,ad)},R=function(){X.hide();var ac={},ab=V.serialize();g.each(ab.split("&"),function(ae,ad){ad=ad.split("=");ac[ad[0]]=ad[1]});e.post(E,{title:ac["vote-title"],description:ac["vote-desc"],max_choice:ac.maxchoices,expire_time:ac["expire-day"]+" "+ac["expire-hour"]+":"+ac["expire-minute"],choice:ab,share_to:Array.prototype.map.call(V.find(".sns-sync-btn"),function(ad){return ad.checked?ad.value:""})},function(ad){if(!ad.r){r.close();M.renderContent();M.renderList()}},"json")};U.bind("click",function(ab){ab.preventDefault();W.toggle()});T.bind("click",function(ab){ab.preventDefault();r.close()});g(".sns-sync-field",V).delegate(".sns-sync-btn","click",function(ac){var ab=g(ac.target).val();if(!C[ab]&&!u(ab+"_cookie_bound")){var ad={ap_douban:{text:"绑定豆瓣帐号",link:"/accounts/oauth_login_request?source=ap_douban"},ap_weibo:{text:"绑定微博帐号",link:"/accounts/oauth_login_request?source=ap_weibo"}};r.confirm(h.format('请先绑定帐号：<a href="{{link}}" target="_blank">{{text}}</a>',ad[ab]));ac.preventDefault()}});V.bind("submit",function(ab){ab.preventDefault();x({items:[{con:!Z.val().trim(),error:"请填写投票主题"},{con:(new Date()>S()),error:"结束时间不能早于当前时间"}],errDiv:X,success:R})});p.wait("dialog:close",function(){T.unbind("click");V.unbind("submit");l.html("")})})},activate:function(P,Q){p.wait("widget:nav",function(R){G.navigate(R)})},destroy:function(P,Q){O.remove()}});G.navigate=function(P){M.navigate(P)};function y(Q,P){a.init(F[0],{hasShadow:true});F.animate({scrollTop:0},200);f.commentEvt({base:J,wrap:F,url:L,id:Q,commentDetail:P,tmplExtra:K});g(".item-mark",J).bind("mouseenter",function(R){g(this).addClass(d)}).bind("mouseleave",function(R){g(this).removeClass(d)}).bind("click",function(S){if(S.target.className=="citizen"){return}var R=g("input",this),T=R.prop("checked");if(R.attr("type")==="radio"){g(".item-mark",J).removeClass(c)}if(R.length){if(S.target.tagName==="INPUT"||S.target.tagName==="LABEL"){T=!T}R.prop("checked",T?"":"checked");g(this)[!T?"addClass":"removeClass"](c)}});g(".self-rec .bn-green",J).bind("click",function(R){R.preventDefault();e.post(L+Q+"/vote",function(S){if(!S.r){M.renderContent(Q)}else{j.alert(S.msg)}},"json")});g(".voting-form",J).bind("submit",function(S){S.preventDefault();if(g(".vote-list",J).find(":checked").length){S.preventDefault();var T=parseInt(g(".maxchoice",J).text(),10),R=g(":checked",this).attr("id").split("-")[1];e.post(L+Q+"/vote?needauth=1",{choice:R},function(U){if(!U.r){M.renderContent(Q)}else{if(U.r==20){p.fire("citizen:submit-disabled",[U.reason])}}},"json")}});g(q,F).bind("click",function(R){R.preventDefault();if(R.target.className==="del"){j.alert("确定删除此投票？",function(){e.post(L+Q+"/delete",function(S){if(!S.r){M.renderContent();M.renderList()}else{r.confirm("投票删除失败，请稍后再试")}})})}})}function x(P){var Q=false;g.each(P.items.reverse(),function(S,R){if(R.con){Q=true;P.errDiv.text(R.error).show()}});f.switchBnDisabled(g("#submit",t),Q);if(!Q){P.success()}}return G};return n});