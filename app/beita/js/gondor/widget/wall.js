define("gondor/widget/wall",["lib/jquery","mod/lang","gondor/toolkit","gondor/view","mod/scrollbar","gondor/widget/common","gondor/observer","gondor/sandbox"],function(f,o,n,l,q,m,j,h){var d="tplWallComment",p="tplWallComments",a="tplWallList",e=".wall-comment",g=".wall-comment-list",b=".wall-comment-form",k=".wall-comment-input",i=".wall-comment-submit";var c=function(s){var C=s.pid,B=s.wid,u=s.address,x=s.userInfo,E={userInfo:x,widgetInfo:{pid:C,wid:B,address:u}},D=f("#widget-"+B+" .home"),K=f(".wall-list",D),J=f(".bn-post",D),y=f(".wall-form",D),r=f(".wall-post",D),I=f(".wall-submit",D),F="/api/place/"+C+"/widget/"+B,w=F+"/discussion/",t=F+"/wall_add?needauth=1",G=F+"/wall_list";var A=new h({init:function(L,M){m.resize(L,D,60);m.scrollLoad(D,{action:v});H();r.bind("keyup",function(N){z(N.target.value)});m.switchBnDisabled(I,0);y.bind("submit",function(N){N.preventDefault();m.switchBnDisabled(I,0);n.post(t,{text:r.val()},function(O){if(!O.r){r.val("");m.render({url:G,data:E,args:{limit:1},wrapper:K,method:"prepend",tplname:a},"oneLoaded");m.evt.wait("oneLoaded",function(){q.init(D[0],{hasShadow:true})})}else{if(O.r==20){j.fire("citizen:submit-disabled",[O.reason])}}},"json")});D.delegate(".wall-list","click",function(P){var N=P.target;if(N.tagName==="A"){P.preventDefault()}if(N.className==="wall-topic-del"){l.alert("确定要删除此留言？回复将一并被删除",function(){var R=f(N).parent().data("tid");n.post(w+R+"/delete",function(){f(N).parent().parent().fadeOut(250,function(){f(this).remove();q.init(D[0],{hasShadow:true})})})})}if(N.className==="wall-cmt-del"){l.alert("确定要删除此回复？",function(){var R=f(N).parents(".wall-comment").prev("p").data("tid"),S=f(N).parent().data("cid");n.post(w+R+"/delete_comment",{cid:S},function(){f(N).parent().fadeOut(250,function(){f(this).remove();q.init(D[0],{hasShadow:true})})})})}if(N.className==="reply"){var O=f(N).parent();if(N.innerHTML!=="隐藏回应"){var Q=f(N).parent().data("tid");N.innerHTML="回应加载中...";N.className="reply-loading";m.render({url:w+Q+"/get_comments",data:E,wrapper:O,method:"after",tplname:p},"commentsLoaded");m.evt.wait("commentsLoaded",function(){q.init(D[0],{hasShadow:true});var R=O.next(),T=R.find("ul"),S=R.find(b),V=S.find(k),U=S.find(i);m.switchBnDisabled(U,0);S.bind("submit",function(X){X.preventDefault();var W=V.val();if(W){m.switchBnDisabled(U,0);n.post(w+Q+"/add_comment?needauth=1",{text:W},function(Y){if(!Y.r){m.render({data:o.mix(Y,E),wrapper:T,method:"append",tplname:d});q.init(D[0],{hasShadow:true});V.val("").focus()}else{if(Y.r==20){j.fire("citizen:submit-disabled",[Y.reason])}}},"json")}});V.bind("keyup",function(W){m.switchBnDisabled(U,W.target.value)});N.innerHTML="隐藏回应";N.className="reply"})}else{if(N.innerHTML==="隐藏回应"){N.innerHTML=O.next().find("ul").children().length+"回应";f(N).parent().next(e).remove()}}}})},destroy:function(L,M){r.remove();y.remove();D.remove()}});function v(){var L=K.children().length;m.render({url:G,data:E,args:{start:L,limit:30},wrapper:K,method:"append",tplname:a},"topicLoaded");m.evt.wait("topicLoaded",function(){q.init(D[0],{hasShadow:true})})}function H(){m.render({url:G,data:E,args:{limit:30},wrapper:K,method:"html",tplname:a},"reloaded");m.evt.wait("reloaded",function(){q.init(D[0],{hasShadow:true})})}function z(L){I[L?"addClass":"removeClass"]("active").prop("disabled",L?"":"disabled")}return A};return c});