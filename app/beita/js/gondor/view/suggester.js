define("gondor/view/suggester",["lib/jquery","mod/lang","mod/template","mod/mention","gondor/observer","host","gondor:domain"],function(e,j,a,g,f,k,d){var i=k.window.document;var c={limit:10,delay:200,offset:{top:20,left:0}};var b={"@":{name:"citizen",model:"people:search",template:'<ul class="suggest-citizen">                       {% for (var i=0; i<items.length; i++) { %}                           <li class="{%= i==0 ? "on" : ""%}" data-id="{%= items[i].id%}" data-name="{%= items[i].name%}">                              <img src="{%= items[i].avatar%}"/>                              {%= items[i].formattedName || items[i].name %}                           </li>                       {% } %}                       </ul>',tip:'<div class="tip">@某人，TA能收到你的消息</div>'},"#":{name:"place",model:"node:search",template:'<ul class="suggest-place">                       {% for (var i=0; i<items.length; i++) { %}                           <li class="{%= i==0 ? "on" : ""%}" data-id="{%= items[i].id%}" data-name="{%= items[i].name%}">                           {% if (items[i].avatar) { %}                              <img src="{%= items[i].avatar%}"/>                           {% } %}                              {%= items[i].formattedName || items[i].name %}                           </li>                       {% } %}                       </ul>',tip:'<div class="tip">#标记某地点</div>'}};var l=e('<div class="suggester-overlay"></div>');var h=function(m){this.settings=j.mix(c,m)};h.destroy=function(){l.remove();l.unbind();l.undelegate()};h.prototype={events:{"click li":"pick","mouseenter li":function(m){l.find("li").removeClass("on");e(this).addClass("on")}},delegateEvents:function(q){q=q||this.events;l.undelegate();l.unbind();for(var p in q){var r=q[p];if(!j.isFunction(r)){r=this[q[p]].bind(this)}var o=p.match(/^(\S+)\s*(.*)$/);var n=o[1],m=o[2];if(m===""){l.bind(n,r)}else{l.delegate(m,n,r)}}},show:function(r,v,n,u){var s=b[r];if(s===undefined){return}var q=s.tip,o,t=this;t._mentionInput=u;l.appendTo(i.body);this.delegateEvents();l.html(q);p();clearTimeout(t._query_ref);t._query_ref=setTimeout(function(){var w={query:v,start:0,limit:t.settings.limit};if(u.context!==undefined){w.context=encodeURIComponent(u.context)}f.fire("suggester:query",[s.model,w,function(x){if(!x.r){o=x.data;if(Array.isArray(o)&&o.length>0){q=a.convertTpl(s.template,m(v,o),"items")}else{return}}l.html(q);p()}])},t.settings.delay);function p(){l.show();l.css({top:n.top+t.settings.offset.top,left:n.left+t.settings.offset.left,marginTop:n.marginTop,marginLeft:n.marginLeft})}function m(w,x){x.forEach(function(y){y.formattedName=y.name.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+w+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")});return x}},clear:function(){clearTimeout(this._query_ref);l.empty().hide()},move:function(p){var n=l.find("li"),m=n.length,o=l.find("li.on").index();if(!m){return}o+=p;if(o>=m){o-=m}if(o<0){if(o===-2){o=-1}o+=m}l.find("li").removeClass("on");e(n[o]).addClass("on")},pick:function(){var n=l.find("li.on");if(n.length<1){return}var m=e.trim(n.data("name"))+"("+n.data("id")+")";if(this._mentionInput){this._mentionInput.powerInsert(m)}this.clear()}};return function(m){return new h(m)}});