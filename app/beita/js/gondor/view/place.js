define("gondor/view/place",["lib/jquery","mod/lang","mod/template","gondor/observer","gondor/view/node"],function(f,n,a,k,j){var e=["N","S","W","E"],h={N:"W",S:"W",W:"N",E:"N"},g={N:"E",S:"E",W:"S",E:"S"},i=60,d=200,c=10,o=14,p=70,m={"10007":800},l=976;var b=n.mix(Object.create(j),{init:function(q){j.init.call(this,q);this.placard=f(".place-info",this.viewport);this.disablePlaceInfoToggle=false},enable:function(){f(this.canvas.viewport).removeClass("disabled");this.disablePlaceInfoToggle=false},disable:function(){f(this.canvas.viewport).addClass("disabled");this.disablePlaceInfoToggle=true},exit:function(r){var q=this;this.placard[0].className="place-info";k.fire("place:exit",[r]);k.wait("viewport:ready",function(){j.exit.call(q);q.disable();k.fire("place:disable")})},move:function(q){var s=this.activity[this.vision];if(!s){return false}var r=s.neighbors[q];if(!r){return false}this.togglePlaceInfo(r[1]);return j.move.apply(this,arguments)},togglePlaceInfo:function(q){if(this.disablePlaceInfoToggle){return}if(q==13){this.placard.addClass("disabled")}else{this.placard.removeClass("disabled")}k.fire("shop:togglePlaceInfo",[q])},updatePlaceInfo:function(r){if(r.collected!==undefined){var q=this.placard.find(".bookmark-btn");if(q[0]){var s=q.html().toLowerCase().replace(/.+<em.+?>(\d+)(.+<\/em>)/,function(t,x,v){var u=r.collect_num||0;var w=u>0?'<em class="donothing">':'<em class="donothing" style="display:none;">';return w+u+v});if(r.collected){q.addClass("bookmarked");q.html('<span>已经喜欢</span><span class="bookmark-btn bookmarked">取消喜欢</span>'+s)}else{q.removeClass("bookmarked");q.html("喜欢"+s)}}}},render:function(s,v){var E=this,t=this.activity,G=v.focus,r=G.id;if(t[r]){return}var y=!this.activelist.length;this.aligning(r,G);this.activity[r].widget_id=G.widget_id;var A=this.canvas,z=A.config,C=z.width,x=z.height,q={},B={},D=[];q.id=G.id;q.widget_id=G.widget_id;q.widget_name=G.widget_name;q.widget_kind=G.widget_kind;q.functionStyle=G.functionStyle;q.borders=e.map(function(H){var w={toward:H};if(!G.nears[H]||this[H]&&(this[H][1]==8||this[H][1]==13)){w.outer=true;D.push(H);if(q.functionStyle!=="backyard"){if(H=="S"){x-=i}}}if(this[H]){w.id=this[H][0];w.outer_kind=this[H][1];w.hasDoor=true;w.emitterStyle="";w.outer_name=v.info.room_style=="house"&&"出门转转"||w.outer_kind==13&&"后花园"||q.functionStyle=="backyard"&&"回室内"||w.outer&&"出门"||"";w.widget_name=G[H].widget_name;w.uri=G[H].uri}B[H]=w;return w},G.neighbors);q.borders.forEach(function(M){var N=M.toward,K=N=="N"||N=="S",J=K?z.width:(M.outer?z.height:(z.height-o)),I=J,H=0,w=0;if(M.outer&&N=="W"&&B[g[N]].outer||N=="E"&&B[g[N]].outer){I-=i}if(M.hasDoor){H=w=(J-d)/2}if(B[h[N]].outer){if(q.functionStyle!=="backyard"){}else{H-=d/2}}if(B[g[N]].outer&&!K){w-=i}if(M.hasDoor){var L=H;if(!K&&!M.outer){L+=c}if(M.outer&&!K){L-=c}M.arrowStyle=(K?"left":"top")+":"+L+"px";M.wallStyle_right=(K?"width":"height")+":"+w+"px;";M.wallStyle=(K?"width":"height")+":"+H+"px;"}else{M.wallStyle=(K?"width":"height")+":"+I+"px;"}});q.outers=D;if(q.functionStyle==="backyard"){q.outerStyle="height:"+x+"px;";q.wgtStyle="height:"+x+"px;"}else{q.outerStyle="width:"+C+"px;height:"+x+"px;"+D.map(function(w){if(w=="S"){return"margin-"+this[w]+":"+(i-1)+"px;border-"+this[w]+"-width:1px;"}else{return""}},{N:"top",S:"bottom",W:"left",E:"right"}).join("");var u=C-2*p;var F=m[q.widget_kind]||l;if(u>F){u=F}q.wgtStyle="width:"+u+"px;height:"+(x-2*p)+"px;"}v.renderList=[q];this.renderNode(r,v,"tplRoom","node"+(v.info.room_style?" node-style-"+v.info.room_style:""));if(y){this.placard[0].innerHTML=a.convertTpl("tplRoomInfo",v,"room");this.placard.addClass("place-info-style-"+v.info.room_style);this.updatePlaceInfo({collected:!!v.shop_collection[v.info.place_id],collect_num:v.info.n_collect});this.togglePlaceInfo(G.kind)}}});return b});