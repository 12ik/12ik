define("gondor/view/guide",["lib/jquery","mod/lang","mod/browsers","mod/template","mod/stick","mod/mainloop","gondor/observer","gondor/view/fullmap"],function(b,q,j,c,n,f,m,i){var d=20,k,l,g=0,r='<div class="pathline" style="width:{{w}}px;height:{{h}}px;top:{{y}}px;left:{{x}}px;{{border}};background:{{bgcolor}};{{rotate}}"></div>',h='<div class="overlap guide-btn-box"><a class="guide-btn start" href="#" title="立刻去这里">前往</a><a class="guide-btn cancel" href="#">取消</a></div>',e='<span class="guide-arrow"><em class="guide-arrow"></em><span class="guide-tips" style="display:none"></span></span>',o="-moz-transform: rotate({{0}}deg);-moz-transform-origin: 0% 0%; -webkit-transform: rotate({{0}}deg);-webkit-transform-origin: 0% 0%; -ms-transform: rotate({{0}}deg);-ms-transform-origin: 0% 0%; -o-transform: rotate({{0}}deg);-o-transform-origin: 0% 0%; transform: rotate({{0}}deg);transform-origin: 0% 0%;";var p={showPath:function(v){v=v||l;l=v;if(!l){return}var w=i,u=[0,0],x=v.ways_start[0],s=v.ways_end[0];if(x==s){return}if(v.forward==="E"||v.forward==="S"){u=[10000,10000]}var t=v.ways.map(function(y,z){if(!y||!y.length){return""}return y.map(function(D,F){var B=D[0],H=w.getPos(B),K=H[0],I=H[1],L=H[2].width(),G=H[2].height(),M=Math.floor(d/2)-1;if(L==G){var E="";if(F===0&&z!==0){if(!j.msie||j.msie>8){var C=u[0]-K,A=u[1]-I,J=Math.atan(Math.abs(A/C))*180/Math.PI;if(C>=0&&A<0){J=360-J}else{if(C<0&&A<0){J+=180}else{if(C<0&&A>=0){J=180-J}}}E=c.format(r,{border:"border-top:2px dashed #C93313",rotate:c.format(o,[J]),x:K,y:I,w:Math.sqrt(Math.pow(Math.abs(C),2)+Math.pow(Math.abs(A),2)),h:0})}else{E=c.format(r,{border:"border-top:2px dashed #C93313",x:u[0]>K?K:u[0],y:u[1],w:Math.abs(u[0]-K),h:0})+c.format(r,{border:"border-left:2px dashed #C93313",x:K,y:u[1]>I?I:u[1],w:0,h:Math.abs(u[1]-I)})}}u=H;if(L==d){return E+c.format(r,{bgcolor:"#C93313",x:K-2,y:I-2,w:3,h:3})}return""}else{if(L>G){if(B==x||B==s){if(u[0]<H[0]){K-=L/2+M}L=L/2+M}else{K-=L/2+M;L+=M*2}I-=2;G=3}else{if(B==x||B==s){if(u[1]<H[1]){I-=G/2+M}G=G/2+M}else{I-=G/2+M;G+=M*2}K-=2;L=3}u=H;return c.format(r,{bgcolor:"#C93313",x:K,y:I,w:L,h:G})}}).join("")}).join("");b(w.detailLayer.map).append(t)},clearPath:function(){b(".pathline",i.detailLayer.map).remove();if(this.guideBtns){this.guideBtns.hide()}},updatePath:function(s){l=s},showInfo:function(){return l},mark:function(u,v,s){var t=this;this.targetName=v;this.clearPath();i.clearMark();i.mark(u.ways_end[0],v).then(function(){t.showPath(u);s()})},markAndNav:function(u,v,t){var s=this;this.targetName=v;this.clearPath();i.clearMark();i.mark(u.ways_end[0],v).then(function(){var z=i;if(!z.opened){return}s.showPath(u);var w=z.getPos(u.ways_end[0]),A={left:w[0]-134/2,top:w[1]+10};if(!s.guideBtns){s.guideBtns=b(h).appendTo(z.detailLayer.map)}var x=/(\w+)\/?(\?cid=\w+|$)/.exec(u.uri)||[];var y;if(t&&t.from_opt){y=c.format("#id={{id}}&kind={{kind}}&place_domain={{place_domain}}&place_kind={{place_kind}}",t.from_opt)}s.guideBtns.find(".start").attr("href","#nav_id="+u.nav_id+"&nav_kind="+u.nav_kind+"&cid="+x[2].replace("?cid=","")).end().find(".cancel").attr("href",y||"#").end().css(A).show()})},hide:function(){},finish:function(s){this.autonav=false;this._firstTips=false;k=null;this.clearPath();i.clearMark();m.unbind("fullmap:open",a);m.fire("guide:finish",[s])},showContent:function(s){m.fire("guide:content",[{id:s.target_id,index:s.target_index}])}};function a(){p.clearPath();p.showPath()}return p});