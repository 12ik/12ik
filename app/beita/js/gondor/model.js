define("gondor/model",["mod/lang","mod/datasource","mod/cookie","gondor/observer"],function(t,f,s,p){var q="/api",i="/accounts",r=["N","S","W","E"],j={N:"S",S:"N",W:"E",E:"W"},g={"90":{N:"E",S:"W",W:"N",E:"S","0":1,"1":0,"2":3,"3":2},"180":{N:"S",S:"N",W:"E",E:"W","0":0,"1":1,"2":2,"3":3},"270":{N:"W",S:"E",W:"S",E:"N","0":1,"1":0,"2":3,"3":2}},n={"0":"street","1":"street","2":"avenue","3":"avenue","4":"cross","5":"cross","6":"cross","7":"room","8":"door","13":"room","10":"shop","11":"home"},a={street:"node",avenue:"node",cross:"node",shop:"place",home:"place",door:"door",room:"room"},l=[{hd:"#FCC97A",hdBorder:"#DFA448",hdText:"#755215"},{hd:"#817C76",hdBorder:"#133109",hdText:"#fff"},{hd:"#3D83A0",hdBorder:"#7DB2C2",hdText:"#fff"},{hd:"#6E8459",hdBorder:"#6D8359",hdText:"#fff"}],e={"1001":"shop-official-st","1002":"house","1003":"shop-official-av","1004":"shop-official-center","1005":"shop-subway","1006":"shop-cm"},o={"13":"backyard"},d={place:"1004",people:"1006"},h={},m={},k=s("gck")||"",b={"node:view":{remote:"/node/{{nid}}/view?dest={{dest}}&pdest={{pdest}}&content_id={{content_id}}&home={{home}}&rent_mode={{mode}}",expire:0.3,filter:function(u,F){if(F.r){return}var v=l,x={},B=x.entities=t.mix({lib:{},node:[],place:[],room:[],door:[]},n);if(u.userInfo){x.userInfo=u.userInfo;x.userHasShop=u.userInfo.own_shops.length}x.shop_collection=u.syncDB?u.syncDB.shop_collection:{};x.layerMode=u.mode||0;if(F.waypoint){F.waypoint.reverse().pop();x.waypoint=F.waypoint}else{x.waypoint=[]}F.entities.forEach(function(M){if(M.kind==10){var N=M.theme,J=parseInt(M.num/2-1,10)%4,L=v[J]||v[0];if(!N){N=M.theme={}}for(var O in L){if(!N[O]){N[O]=L[O]}}if(M.joke){M.num_style=" num-style theme"+J}}M.room_style=e[M.place_kind]||"";M.is_commercial=M.room_style==="shop-cm";M.functionStyle=o[M.kind]||"";if(M.place_kind==1005){M.subway_name=M.name.substr(0,M.name.length-1)}var I=this[M.kind];var K=this[a[I]];this.lib[M.id]=M;K.push(M)},x.entities);var H,E=F.info;if(!E){var y=B.node;H=y.filter(function(I){return I.id==this.nid},u)[0]||y[0]}else{var w=B.room,z=B.door[0];if(z){for(var G in z.neighbors){if(z.neighbors[G]){H=B.lib[z.neighbors[G][0]]}}}else{H=w.filter(function(I){return I.id==this.nid},u)[0]}x.info=E;E.street_uri="/"+(E.street_kind<2&&"street"||E.street_kind<4&&"avenue"||E.street_kind<7&&"cross")+"/"+E.street_id+"/";E.room_style=e[E.place_kind]||""}H.parentInfo=E||{};x.focus=H;var C=[],A=0;r.forEach(function(J){var I=this.neighbors[J];if(I){A++;this.isEnd=J;if(E){if(!this.nears){this.nears={}}this.nears[J]=I;if(I[2]){this.neighbors[J]=null}}var K=this[J]=B.lib[I[0]];if(E){if(K.kind==8){K.uri=E.street_uri}else{K.uri="/"+(E.kind==10&&"shop"||E.kind==12&&"home")+"/"+E.place_domain+"/room/"+I[0]+"/"}}else{K.uri="/"+(K.kind<2&&"street"||K.kind<4&&"avenue"||K.kind<7&&"cross")+"/"+I[0]+"/"}if(I[1]>=2){C.push(J)}}},H);H.shape=C.join("");if(A==1){H.isEnd=j[H.isEnd]}else{H.isEnd=false}var D=[{}].concat(F.breadcrumb||[]);D.push(E?({place_name:E.name,place_domain:E.place_domain}):({node_name:H.name||"路口",node_id:H.id,node_kind:H.kind}));D.forEach(function(J,I){J.kind_name=J.area_id&&"area"||J.node_kind&&n[J.node_kind]||J.place_domain&&"place"||""});x.breadcrumb=D;return x}},"node:info":{remote:"/node/{{nid}}/info?sync={{need_sync}}&walk={{is_walk}}&nav={{nav}}&content_id={{content_id}}&local={{need_local}}&ck="+encodeURIComponent(k)+"&d={{date}}&p={{place_id}}&w={{widget_id}}&ver=1",filter:function(y,x){if(x.r){return}x.tm=y.date;x.soundlib={};x.sound.forEach(function(A){this[A.id]=A},x.soundlib);var w=x.user;w.adminLib={};if(w.admin_shops){w.admin_shops.forEach(function(A){this[A]=1},w.adminLib);w.isShopAdmin=true}else{w.admin_shops=[]}if(w.own_shops){w.own_shops.forEach(function(A){this[A]=2},w.adminLib);w.isShopAdmin=true}else{w.own_shops=[]}if(w.admin_nodes){w.admin_nodes.forEach(function(A){this["node-"+A]=1},w.adminLib)}else{w.admin_nodes=[]}var v=x.sync;var u={};(v.shop_collection||[]).forEach(function(A){this[A]=true},u);v.shop_collection=u;var z={};(v.unread_tips||[]).forEach(function(A){this[A]=true},z);v.unread_tips=z}},"map:view":{remote:"/node/all_nodes",expire:9000,filter:function(v,u){u.arealib={};u.areas.forEach(function(w){this[w.id]=w;w.nodes={}},u.arealib);u.lib={};u.nodes.forEach(function(w){this.lib[w.id]=w;w.kind_name=n[w.kind];if(w.area){this.arealib[w.area].nodes[w.id]=w}},u)}},"map:info":{remote:"/map?area_id={{area_id}}"},"node:list":{remote:"/node/{{nid}}/list?page={{page}}",filter:function(v,u){var w=u.info={};t.mix(w,v);w.userHouse=w.userHouse||""}},"node:search":{remote:"/mention/guess_place?query={{query}}&start={{start}}&limit={{limit}}",filter:function(v,u){var w=a;if(u.r){return}u.lists={};u.data.forEach(function(x){if(!x.name){return}var y=w[x.type];if(!this[y]){this[y]=[]}this[y].push(x)},u.lists)}},"people:search":{remote:"/mention/guess_user?query={{query}}&context={{context}}&start={{start}}&limit={{limit}}"},"node:guide":{remote:"/node/{{nid}}/uri_guide?uri={{uri}}",filter:function(x,v){var u=v.ways;if(u){v.ways_start=(u[0]||[])[0]||[];u=u[u.length-1]||[];v.ways_end=u[u.length-1]||[]}}},"place:theme":{remote:"/place/{{pid}}/set_theme?hd={{hd}}&hdBorder={{hdBorder}}&hdText={{hdText}}",post:true},"place:collect":{remote:"/place/{{pid}}/collect_op?op={{op}}&needauth=1",post:true},"place:checkincome":{remote:"/place/{{pid}}/mark_read_received_money",post:true},"card:info":{remote:"/card/?uri={{id}}"},"house:op":{remote:"/node/{{nid}}/resident_op?op={{op}}&sub_op=exec",post:true},"citizen:cardinfo":{remote:"/user/{{id}}/card"},"citizen:shops":{remote:"/user/{{uid}}/shops"},"citizen:pick":{root:i,remote:"/pick?para={{para}}",post:true},"citizen:update":{remote:"{{api}}?op={{op}}&desc={{desc}}&name={{name}}",post:true},"citizen:bookmarks":{remote:"/user/{{uid}}/collections?start={{start}}&limit=20"},"citizen:cardbox":{remote:"/user/{{uid}}/collections?cate="+d.people+"&start={{start}}&limit={{limit}}"},"citizen:sonorus":{remote:"/notification/list?kind={{kind}}&start={{start}}&limit={{limit}}",filter:function(v,u){u.forEach(function(w){w.userId=this.userId},v)}},"citizen:like":{remote:"/user/{{uid}}/collect_op?op={{op}}&needauth=1",post:true},"citizen:checkincome":{remote:"/user/{{uid}}/mark_read_received_money",post:true},"sonorus:read":{remote:"/notification/mark_read?nid={{noti_id}}",post:true},"tips:mark":{remote:"/user/{{uid}}/mark_tip?tip={{tip}}",post:true},"joke:pick":{remote:"/user/children_special?node_id={{nid}}&bingo={{bingo}}",post:true},"badge:info":{remote:"/badge/{{bid}}/info"},"badge:readed":{remote:"/badge/{{bid}}/mark_read",post:true},"activity:poster":{remote:"/place/{{pid}}/widget/{{wid}}/activity/{{aid}}/poster"},"activity:follow":{remote:"/place/{{pid}}/widget/{{wid}}/activity/{{aid}}/add_action?action=3504",post:true}};var c=function(w){var y=m,x=y[w];if(!x){var u=b[w];t.mix(u,h);u.callback="_alphatown_api_handler";var v=u.filter;u.filter=function(A,z){if(z.r==20){p.fire("citizen:submit-disabled",[z.reason]);return false}else{if(v){return v.apply(this,arguments)}}};if(u.post){u.data=t.mix(u.data||{},{ck:k})}if(!u.root){u.root=q}x=y[w]=f(u)}return x};c.config=function(u){t.mix(h,u)};return c});